#!/usr/bin/env tsx

/**
 * Sitemap Validation Script
 *
 * This script validates the generated sitemap.xml to ensure all
 * expected page types are included and properly structured.
 */

import { readFileSync } from 'fs';
import { join } from 'path';

const PROJECT_ROOT = process.cwd();
const SITEMAP_PATH = join(PROJECT_ROOT, 'public', 'sitemap.xml');

function validateSitemap() {
  try {
    console.log('üîç Validating sitemap.xml...\n');

    const sitemapContent = readFileSync(SITEMAP_PATH, 'utf8');
    const urls = sitemapContent.match(/<loc>(.*?)<\/loc>/g) || [];
    const urlList = urls.map(url => url.replace(/<\/?loc>/g, ''));

    console.log(`üìä Total URLs found: ${urlList.length}\n`);

    // Categorize URLs
    const categories = {
      homepage: urlList.filter(url => url === 'https://eyecarecenteroc.com/'),
      mainPages: urlList.filter(url =>
        /\/(?:about|services|contact|eyewear|fashion|conditions)$/.test(url) && !url.includes('/es/')
      ),
      spanishPages: urlList.filter(url => url.includes('/es/')),
      conditionPages: urlList.filter(url =>
        /\/conditions\/[^\/]+$/.test(url) && !url.includes('/es/')
      ),
      spanishConditionPages: urlList.filter(url =>
        /\/es\/conditions\/[^\/]+$/.test(url)
      ),
      locationPages: urlList.filter(url => /\/locations\/[^\/]+$/.test(url)),
      spanishLocationPages: urlList.filter(url => /\/es\/locations\/[^\/]+$/.test(url)),
      neighborhoodPages: urlList.filter(url => /\/neighborhoods\/[^\/]+$/.test(url)),
      serviceLocationPages: urlList.filter(url => /\/services\/[^\/]+\/[^\/]+$/.test(url)),
      serviceIndexPages: urlList.filter(url =>
        /\/services\/[^\/]+$/.test(url) && !url.includes('/es/')
      ),
      educationalPages: urlList.filter(url => /\/education\//.test(url)),
      specialPages: urlList.filter(url =>
        url.includes('/keratoconus-referral') ||
        url.includes('/privacy-policy') ||
        url.includes('/terms-of-service')
      )
    };

    console.log('üìã URL Categories:');
    Object.entries(categories).forEach(([category, urls]) => {
      console.log(`  ‚Ä¢ ${category}: ${urls.length} URLs`);
    });

    console.log('\nüéØ Key Route Validations:');

    // Check for high-priority pages
    const criticalPages = [
      'https://eyecarecenteroc.com/',
      'https://eyecarecenteroc.com/about',
      'https://eyecarecenteroc.com/services',
      'https://eyecarecenteroc.com/contact',
      'https://eyecarecenteroc.com/conditions',
      'https://eyecarecenteroc.com/conditions/keratoconus',
      'https://eyecarecenteroc.com/conditions/dry-eye',
      'https://eyecarecenteroc.com/locations/irvine-eye-doctor',
      'https://eyecarecenteroc.com/neighborhoods/woodbridge-eye-doctor',
      'https://eyecarecenteroc.com/services/optometrist-near-me',
      'https://eyecarecenteroc.com/es/',
      'https://eyecarecenteroc.com/es/conditions/keratoconus'
    ];

    let missingPages = 0;
    criticalPages.forEach(page => {
      const found = urlList.includes(page);
      console.log(`  ${found ? '‚úÖ' : '‚ùå'} ${page}`);
      if (!found) missingPages++;
    });

    console.log('\nüåê Multilingual Coverage:');
    console.log(`  ‚Ä¢ English pages: ${urlList.filter(url => !url.includes('/es/')).length}`);
    console.log(`  ‚Ä¢ Spanish pages: ${categories.spanishPages.length}`);

    console.log('\nüè• Service Coverage:');
    const serviceTypes = [
      'optometrist-near-me',
      'dry-eye-doctor-near-me',
      'keratoconus-specialist-near-me',
      'scleral-lens-specialist-near-me',
      'myopia-control',
      'orthokeratology',
      'headache-eye-fatigue'
    ];

    serviceTypes.forEach(service => {
      const servicePages = urlList.filter(url => url.includes(`/services/${service}`));
      console.log(`  ‚Ä¢ ${service}: ${servicePages.length} pages`);
    });

    console.log('\nüèòÔ∏è Geographic Coverage:');
    const cities = [
      'irvine', 'newport-beach', 'costa-mesa', 'santa-ana',
      'tustin', 'anaheim', 'orange', 'villa-park'
    ];

    cities.forEach(city => {
      const cityPages = urlList.filter(url => url.includes(city));
      console.log(`  ‚Ä¢ ${city}: ${cityPages.length} pages`);
    });

    console.log('\nüìà Priority Distribution:');
    const priorityMatches = sitemapContent.match(/<priority>(.*?)<\/priority>/g) || [];
    const priorities = priorityMatches.map(p => p.replace(/<\/?priority>/g, ''));
    const priorityCount = priorities.reduce((acc, priority) => {
      acc[priority] = (acc[priority] || 0) + 1;
      return acc;
    }, {} as Record<string, number>);

    Object.entries(priorityCount)
      .sort(([a], [b]) => parseFloat(b) - parseFloat(a))
      .forEach(([priority, count]) => {
        console.log(`  ‚Ä¢ Priority ${priority}: ${count} pages`);
      });

    // Validation summary
    console.log('\n' + '='.repeat(50));
    console.log('üéâ VALIDATION SUMMARY');
    console.log('='.repeat(50));

    if (missingPages === 0) {
      console.log('‚úÖ All critical pages found');
    } else {
      console.log(`‚ùå ${missingPages} critical pages missing`);
    }

    if (urlList.length >= 340) {
      console.log('‚úÖ Expected page count achieved (340+)');
    } else {
      console.log(`‚ö†Ô∏è Page count below expected (${urlList.length}/340+)`);
    }

    if (categories.spanishPages.length > 0) {
      console.log('‚úÖ Multilingual support confirmed');
    } else {
      console.log('‚ùå No Spanish pages found');
    }

    console.log(`\nüìä Final Statistics:`);
    console.log(`  ‚Ä¢ Total URLs: ${urlList.length}`);
    console.log(`  ‚Ä¢ Unique URLs: ${new Set(urlList).size}`);
    console.log(`  ‚Ä¢ Duplicate URLs: ${urlList.length - new Set(urlList).size}`);

    if (urlList.length === new Set(urlList).size && missingPages === 0) {
      console.log('\nüéØ SITEMAP VALIDATION: PASSED ‚úÖ');
    } else {
      console.log('\n‚ö†Ô∏è SITEMAP VALIDATION: NEEDS ATTENTION');
    }

  } catch (error) {
    console.error('‚ùå Error validating sitemap:', error);
    process.exit(1);
  }
}

validateSitemap();